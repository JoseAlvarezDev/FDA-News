---
interface Props {
    symbol: string;
    data: {
        time: string;
        open: number;
        high: number;
        low: number;
        close: number;
    }[];
}

const { symbol, data } = Astro.props;
// Serialize data for client-side usage
const chartData = JSON.stringify(data);
---

<div class="chart-container" data-symbol={symbol} data-chart={chartData}>
    <div class="chart-header">
        <div class="ticker">{symbol}</div>
        <div class="timeframe">Last 90 Days</div>
    </div>
    <div id={`chart-${symbol}`} class="chart-canvas"></div>
</div>

<script>
    import { createChart, ColorType } from "lightweight-charts";

    const containers = document.querySelectorAll(".chart-container");

    containers.forEach((container) => {
        const symbol = container.getAttribute("data-symbol");
        const rawData = container.getAttribute("data-chart");
        if (!symbol || !rawData) return;

        const data = JSON.parse(rawData);
        const divId = `chart-${symbol}`;
        const chartDiv = document.getElementById(divId);

        if (!chartDiv) return;

        // Create Chart
        const chart = createChart(chartDiv, {
            layout: {
                background: { type: ColorType.Solid, color: "transparent" },
                textColor: "#94a3b8",
            },
            grid: {
                vertLines: { color: "rgba(255, 255, 255, 0.05)" },
                horzLines: { color: "rgba(255, 255, 255, 0.05)" },
            },
            width: chartDiv.clientWidth,
            height: 250,
            timeScale: {
                borderColor: "rgba(255, 255, 255, 0.1)",
            },
        });

        const candlestickSeries = (chart as any).addCandlestickSeries({
            upColor: "#10b981",
            downColor: "#ef4444",
            borderVisible: false,
            wickUpColor: "#10b981",
            wickDownColor: "#ef4444",
        });

        candlestickSeries.setData(data);

        // Responsive resize
        const resizeObserver = new ResizeObserver((entries) => {
            if (entries.length === 0 || entries[0].target !== chartDiv) {
                return;
            }
            const newRect = entries[0].contentRect;
            chart.applyOptions({
                width: newRect.width,
                height: newRect.height,
            });
        });

        resizeObserver.observe(chartDiv);
        chart.timeScale().fitContent();
    });
</script>

<style>
    .chart-container {
        width: 100%;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        padding: 0 0.5rem;
    }

    .ticker {
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--color-text-primary);
    }

    .timeframe {
        font-size: 0.75rem;
        color: var(--color-text-secondary);
        background: rgba(255, 255, 255, 0.05);
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
    }

    .chart-canvas {
        width: 100%;
        height: 250px;
    }
</style>
